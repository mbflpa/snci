<cfcomponent>
    <cfcomponent pageencoding = "utf-8">	

    <cffunction name="timelineViewPosicionamentos"   access="remote" hint="componente timeline dos posicionamentos">
        <cfargument name="pc_aval_orientacao_id" type="numeric" required="true" />
        <cfargument name="paraControleInterno" type="string" required="true" />

        <cfquery name="rsPosicionamentos" datasource="#application.dsn_processos#">
			SELECT pc_avaliacao_posicionamentos.*
				, pc_orgaos.* 
				, pc_usuarios.*
				,  pc_orgaos2.pc_org_sigla as orgaoResp
				, pc_orgaos2.pc_org_mcu as mcuOrgaoResp
				, CONVERT(char, pc_aval_posic_datahora, 103) as dataPosic
				, pc_orientacao_status.pc_orientacao_status_finalizador as eHstatusFinalizador
			FROM pc_avaliacao_posicionamentos
			INNER JOIN pc_orgaos on pc_org_mcu = pc_aval_posic_num_orgao
			LEFT JOIN pc_orgaos as pc_orgaos2 on pc_orgaos2.pc_org_mcu = pc_aval_posic_num_orgaoResp
			INNER JOIN pc_usuarios on pc_usu_matricula = pc_aval_posic_matricula
			INNER JOIN pc_orientacao_status on pc_orientacao_status_id = pc_aval_posic_status
			WHERE pc_aval_posic_num_orientacao = <cfqueryparam cfsqltype="cf_sql_integer" value="#arguments.pc_aval_orientacao_id#"> and pc_aval_posic_enviado = 1
                 <cfif arguments.paraControleInterno eq 'N'>  
                    and not pc_aval_posic_status IN(13,14)  
                </cfif>

			ORDER BY pc_aval_posic_dataHora desc, pc_aval_posic_id desc		
		</cfquery>
        
        <!--timeline -->
        <div id="accordionCadItemPainel" >
                            
            <div class="card card-success"  style="padding-bottom: 20px;">
                
                <div class="card-header" style="background-color: #ececec;" >
                        
                    <h4 class="card-title ">	
                        <div  class="d-block" style="font-size:20px;color:gray;font-weight: bold;"> 
                            <i class="fas fa-clock" style="margin-top:4px;"></i><span style="margin-left:10px;font-size:16px;">
                            <span id="tituloParaPDF">
                                <cfif #rsProc.pc_orgHerancaMcuPara# neq '' and #rsProc.pc_orientacao_status_finalizador# neq 'S' and (DateFormat(rsProc.pc_aval_orientacao_status_datahora,"dd/mm/yyyy ") gte DateFormat(rsProc.pc_orgHerancaDataInicio,"dd/mm/yyyy"))>
                                    MANIFESTAÇÕES: <cfoutput>Orientação (ID: #rsProc.pc_aval_orientacao_id#) para #rsProc.siglaOrgRespHerdeiro# (item: #rsProc.pc_aval_numeracao# - Processo: #rsProc.pc_processo_id#)</cfoutput></span>
                                <cfelse>
                                    MANIFESTAÇÕES: <cfoutput>Orientação (ID: #rsProc.pc_aval_orientacao_id#) para #rsProc.orgaoRespOrientacao# (item: #rsProc.pc_aval_numeracao# - Processo: #rsProc.pc_processo_id#)</cfoutput></span>
                                </cfif>
                            </span>
                        </div>
                    </h4>
                    <div class="card-tools" align="center">
                        <i id="exportarTimelinePDF"  class="fas fa-file-pdf fa-2x grow-icon" style="color:#b30b00;cursor:pointer;margin-right:20px" title="Exportar o Histórico para PDF" ></i>	
                        <i id="btRecolherPosic"  class="fas fa-eye-slash fa-2x grow-icon" style="color:gray;cursor:pointer;margin-right:20px" title="Recolher todos os posicionamentos" ></i>	
                    </div>
                </div>
                
                <div id="collapseTwo" class="" data-parent="#accordion" style="max-height:400px;overflow: auto">
                    <div class="card-body" >

                        <!-- Timelime -->
                        <div class="row">
                            <div class="timeline" >
                                <cfoutput query = "rsPosicionamentos" group="dataPosic">
                                    <!-- timeline time label -->
                                    <div class="time-label">
                                        <cfset data = DateFormat(#pc_aval_posic_dataHora#,'DD-MM-YYYY') >
                                        <span class="bg-blue">#data#</span>
                                    </div>
                                    <!-- /.timeline-label -->
                                    <cfoutput>
                                        <!-- timeline item -->
                                        <cfif #pc_org_controle_interno# eq 'S' >
                                            <div>
                                                <cfif #pc_aval_posic_status# eq 13>
                                                    <cfset icone = "fa-gear">
                                                <cfelseif #pc_aval_posic_status# eq 14>
                                                    <cfset icone = "fa-lock">
                                                <cfelseif #pc_aval_posic_status# eq 16>
                                                    <cfset icone = "fa-clock">
                                                <cfelse>
                                                        <cfset icone = "fa-user">
                                                </cfif>

                                                <cfif ListFind("13,14,16", #pc_aval_posic_status#)>
                                                    <cfset cor = "bg-red">
                                                <cfelse>
                                                    <cfif arguments.paraControleInterno eq 'S'>     
                                                        <cfset cor = "##ececec">
                                                    <cfelse>
                                                        <cfset cor = "bg-green">
                                                    </cfset>            
                                                </cfif>


                                                <cfoutput>
                                                    <i class="fas #icone# #cor#"  style="margin-top:6px;color:##fff"></i>
                                                </cfoutput>
                                                <div class="timeline-item">
                                                    <cfset hora = TimeFormat(#pc_aval_posic_dataHora#,'HH:mm') >
                                                    
                                                    <span class="time" style="padding:4px;font-size:9px"><i class="fas fa-calendar"></i> #data#<br><i class="fas fa-clock"></i> #hora#<br><i class="fas fa-key"></i> #pc_aval_posic_id#</span>
                                                    
                                                    <div class="card card-primary collapsed-card posicContInterno" >
                                                        <div class="card-header" style="background-color: <cfif ListFind('13,14,16', #pc_aval_posic_status#)>red<cfelse>##ececec;</cfif>">
                                                            <a class="d-block" data-toggle="collapse" href="##collapseOne" style="font-size:14px;<cfif ListFind('13,14,16', #pc_aval_posic_status#)>##fff<cfelse>color:##00416b</cfif>" data-card-widget="collapse">
                                                                <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus" style="color:<cfif ListFind('13,14,16', #pc_aval_posic_status#)>##fff<cfelse>gray</cfif>"></i>
                                                                </button></i>

                                                                    <cfif pc_aval_posic_status eq 13 or pc_aval_posic_status eq 14  or eHstatusFinalizador eq 'S'>
                                                                        De: #pc_org_sigla# (#pc_usu_nome#) 
                                                                    <cfelse>
                                                                        De: #pc_org_sigla# (#pc_usu_nome#) -> Para: #orgaoResp# (#mcuOrgaoResp#)
                                                                    </cfif>

                                                                
                                                            </a>
                                                        
                                                        </div>
                                                        <div class="card-body" >
                                                            <cfif ListFind("4,5,16", #pc_aval_posic_status#) and pc_aval_posic_dataPrevistaResp neq ''>
                                                                <cfset dataPrev = DateFormat(#pc_aval_posic_dataPrevistaResp#,'DD-MM-YYYY') >
                                                                <pre>#pc_aval_posic_texto#<br><br><p><span>Prazo para resposta: <strong>#dataPrev#</strong></p></pre>
                                                            <cfelse>	
                                                                <pre>
                                                                    #pc_aval_posic_texto#
                                                                    <cfif pc_aval_posic_status eq 15 and pc_aval_posic_numProcJudicial neq ''>
                                                                        <br><p><span>N° Processo Judicial: <strong>#pc_aval_posic_numProcJudicial#</strong></p></span></pre>
                                                                    </cfif>
                                                                </pre>
                                                            </cfif>
                                                            <!--Inicio TabAnexosPosic-->
                                                            <div id="tabAnexosPosicDiv" style="margin-left: 0.75rem;">
                                                                <cfquery datasource="#application.dsn_processos#" name="rsAnexosPosic">
                                                                    Select pc_anexo_nome,pc_anexo_caminho  FROM pc_anexos 
                                                                    WHERE pc_anexo_aval_posic = #pc_aval_posic_id# 
                                                                    order By pc_anexo_id desc
                                                                </cfquery>
                                                                <cfif rsAnexosPosic.recordcount neq 0>
                                                                    <h6>Anexos:</h6>
                                                                    <table id="tabAnexosPosic" class="table table-bordered table-striped table-hover text-nowrap">
                                                                        <tbody>
                                                                            <cfloop query="rsAnexosPosic" >
                                                                                <cfif FileExists(pc_anexo_caminho)>	
                                                                                        <cfset arquivo = ListLast(pc_anexo_caminho,'\')>
                                                                                        <tr style="font-size:12px" >
                                                                                            <td >	
                                                                                                <div style="display:flex;align-items: center;">
                                                                                                    <div>														
                                                                                                        <cfif right(#pc_anexo_caminho#,3) eq 'pdf'>
                                                                                                            <i id="btAbrirAnexo" class="fas fa-eye efeito-grow"   style="cursor: pointer;z-index:100;" onClick="window.open('pc_Anexos.cfm?arquivo=#arquivo#&nome=#pc_anexo_nome#','_blank')"   title="Visualizar" ></i>
                                                                                                        <cfelse>
                                                                                                            <i id="btAbrirAnexo" class="fas fa-download efeito-grow"   style="cursor: pointer;z-index:100;" onClick="window.open('pc_Anexos.cfm?arquivo=#arquivo#&nome=#pc_anexo_nome#','_self')"   title="Baixar" ></i>
                                                                                                        </cfif>
                                                                                                    </div>
                                                                                                    <div style="margin-left:20px">
                                                                                                        <cfif right(#pc_anexo_caminho#,3) eq 'pdf'>
                                                                                                            <i class="fas fa-file-pdf " style="color:red;"></i>
                                                                                                        <cfelseif right(#pc_anexo_caminho#,3) eq 'zip'>
                                                                                                            <i class="fas  fa-file-zipper" style="color:blue;"></i>
                                                                                                        <cfelse>
                                                                                                            <i class="fas fa-file-excel" style="color:green;"></i>
                                                                                                        </cfif>	
                                                                                                    #pc_anexo_nome#</div>
                                                                                                </div>
                                                                                            </td>
                                                                                        </tr>
                                                                                </cfif>
                                                                            </cfloop>	
                                                                        </tbody>
                                                                    </table>
                                                                        
                                                                </cfif>
                                                            </div>
                                                            <!--Fim TabAnexosPosic-->
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        <cfelse>
                                            <!-- timeline item -->
                                            <div>
                                                <cfif pc_aval_posic_status eq 3 ><!--se for uma resposta-->
                                                    <i class="fas fa-user bg-green"  style="margin-top:6px;color:##fff"></i>
                                                <cfelse><!--se não for uma resposta é uma distribuição do órgão avaliado ao órgão subordinador-->
                                                    <i class="fas fa-user ##ececec"  style="margin-top:6px;color:##fff"></i>
                                                </cfif>
                                                <div class="timeline-item">
                                                    <cfset hora = TimeFormat(#pc_aval_posic_dataHora#,'HH:mm') >
                                                    
                                                    
                                                    <span class="time" style="padding:4px;font-size:9px"><i class="fas fa-calendar"></i> #data#<br><i class="fas fa-clock"></i> #hora#<br><i class="fas fa-key"></i> #pc_aval_posic_id#</span>
                                                    
                                                    <div class="card card-primary collapsed-card posicOrgAvaliado" >
                                                    
                                                        <cfif pc_aval_posic_status eq 3 ><!--se for uma resposta-->
                                                            <div class="card-header" style="background-color:##28a745;">
                                                        <cfelse><!--se não for uma resposta é uma distribuição do órgão avaliado ao órgão subordinador-->
                                                            <div class="card-header" style="background-color:##ececec;">
                                                        </cfif>
                                                            <a class="d-block" data-toggle="collapse" href="##collapseOne" style="font-size:16px;<cfif pc_aval_posic_status neq 3 >color:gray</cfif>" data-card-widget="collapse">
                                                                <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus" style="<cfif pc_aval_posic_status neq 3 >color:gray</cfif>"></i>
                                                                </button></i>
                                                                
                                                                    <cfif pc_aval_posic_status eq 3 ><!--se for uma resposta-->
                                                                        De: #pc_org_sigla# (#pc_usu_nome#) -> Para: Controle Interno
                                                                    <cfelse><!--se não for uma resposta é uma distribuição do órgão avaliado ao órgão subordinador-->
                                                                        De: #pc_org_sigla# (#pc_usu_nome#) -> Para: #orgaoResp# (#mcuOrgaoResp#) 
                                                                    </cfif>
                                                                    
                                                            </a>

                                                            

                                                        </div>
                                                        <div class="card-body" >
                                                            <cfif ListFind("4,5,16", #pc_aval_posic_status#) and pc_aval_posic_dataPrevistaResp neq ''>
                                                                <cfset dataPrev = DateFormat(#pc_aval_posic_dataPrevistaResp#,'DD-MM-YYYY') >
                                                                <pre >#pc_aval_posic_texto#<br><br><p><span>Prazo para resposta: <strong>#dataPrev#</strong></p></pre>
                                                            <cfelse>	
                                                                <pre >
                                                                    #pc_aval_posic_texto#
                                                                    <cfif pc_aval_posic_status eq 15 and pc_aval_posic_numProcJudicial neq ''>
                                                                        <br><p><span>N° Processo Judicial: <strong>#pc_aval_posic_numProcJudicial#</strong></p></span></pre>
                                                                    </cfif>
                                                                </pre>
                                                            </cfif>
                                                            <!--Inicio TabAnexosPosic-->
                                                            <div id="tabAnexosPosicDiv" style="margin-left: 0.75rem;">
                                                                <cfquery datasource="#application.dsn_processos#" name="rsAnexosPosic">
                                                                    Select pc_anexo_nome,pc_anexo_caminho  FROM pc_anexos 
                                                                    WHERE pc_anexo_aval_posic = #pc_aval_posic_id# 
                                                                    order By pc_anexo_id desc
                                                                </cfquery>
                                                                <cfif rsAnexosPosic.recordcount neq 0>
                                                                    <h6>Anexos:</h6>
                                                                    <table id="tabAnexosPosic" class="table table-bordered table-striped table-hover text-nowrap">
                                                                        <tbody>
                                                                            <cfloop query="rsAnexosPosic" >
                                                                                <cfif FileExists(pc_anexo_caminho)>	
                                                                                        <cfset arquivo = ListLast(pc_anexo_caminho,'\')>
                                                                                        <tr style="font-size:12px" >
                                                                                            <td >	
                                                                                                <div style="display:flex;align-items: center;">
                                                                                                    <div>														
                                                                                                        <cfif right(#pc_anexo_caminho#,3) eq 'pdf'>
                                                                                                            <i id="btAbrirAnexo" class="fas fa-eye efeito-grow"   style="cursor: pointer;z-index:100;" onClick="window.open('pc_Anexos.cfm?arquivo=#arquivo#&nome=#pc_anexo_nome#','_blank')"   title="Visualizar" ></i>
                                                                                                        <cfelse>
                                                                                                            <i id="btAbrirAnexo" class="fas fa-download efeito-grow"   style="cursor: pointer;z-index:100;" onClick="window.open('pc_Anexos.cfm?arquivo=#arquivo#&nome=#pc_anexo_nome#','_self')"   title="Baixar" ></i>
                                                                                                        </cfif>
                                                                                                    </div>
                                                                                                    <div style="margin-left:20px">
                                                                                                        <cfif right(#pc_anexo_caminho#,3) eq 'pdf'>
                                                                                                            <i class="fas fa-file-pdf " style="color:red;"></i>
                                                                                                        <cfelseif right(#pc_anexo_caminho#,3) eq 'zip'>
                                                                                                            <i class="fas  fa-file-zipper" style="color:blue;"></i>
                                                                                                        <cfelse>
                                                                                                            <i class="fas fa-file-excel" style="color:green;"></i>
                                                                                                        </cfif>	
                                                                                                    #pc_anexo_nome#</div>
                                                                                                </div>
                                                                                            </td>
                                                                                        </tr>
                                                                                </cfif>
                                                                            </cfloop>	
                                                                        </tbody>
                                                                    </table>
                                                                        
                                                                </cfif>
                                                            </div>
                                                            <!--Fim TabAnexosPosic-->
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </cfif>
                                        <!-- END timeline item -->
                                    </cfoutput>	
                                        
                                </cfoutput>
                                
                            <div >
                                <i class="fas fa-clock bg-gray"></i>
                                <div class="timeline-item"></div>
                            </div>
                            
                            
                        </div>
                    </div>
                </div>
            </div>
        
        </div>


    </cffunction>



</cfcomponent >